<?xml version="1.0" encoding="UTF-8"?>
<project name="ion/dev-package" default="info" phingVersion="2.16.3">    
    
<!-- ===========================================
        Target: validate-package
    ============================================ -->  
      
    <target name="validate-package" depends="init">         
          
<!--        <property name="tmp.check-version-return" value="" />-->

        <echo msg="Checking if VCS version needs updating." />
                       
        <exec executable="${state.pkg.cmd}" dir="." returnProperty="tmp.check-version-return" error="NUL" checkreturn="false" passthru="true">
            <arg line="${state.pkg.cmd.version.check}${state.vcs.branches.current.version}" />
        </exec>
        
        <fail message="The package version (${state.pkg.version}) is currently lower than the release VCS version (${state.vcs.branches.current.version}).">
            <condition>
               <equals arg1="${tmp.check-version-return}" arg2="-1"/>
            </condition>
        </fail>    

        <fail message="The package version (${state.pkg.version}) is currently at the release VCS version (${state.vcs.branches.current.version}).">
            <condition>
               <equals arg1="${tmp.check-version-return}" arg2="0"/>
            </condition>
        </fail>    

        <echo msg="The package version (${state.pkg.version}) is currently higher than the release VCS version (${state.vcs.branches.current.version}) - package or release creation can continue!" />

    </target>  
    
        
    <!-- ===========================================
        Target: prepare-package
    ============================================ -->     
    
    
    <target name="prepare-package" depends="init">
        
        <echo msg="No action needed - continuing." />   
                
    </target>                          
    
    <!-- ===========================================
        Target: package
    ============================================ -->         
            
    <target name="package" depends="init, validate-package, templates, tests, clean-cache, builds">
        
        <echo msg="Applying CI/CD configuration ('${state.pkg.devops.current.filename}' -> '${state.pkg.devops.target.filename}')." />
        <copy file="${state.pkg.devops.current.filename}" tofile="${state.pkg.devops.target.filename}" overwrite="true" haltonerror="false" />
        
        <phingcall target="prepare-package" />
                                                                       
        <echo msg="Staging changes to the current GIT branch '${state.vcs.branches.current.name}'." />
        <exec executable="${state.vcs.cmd}" dir="." checkreturn="true" passthru="true">
            <arg line="${state.vcs.cmd.state}" />
        </exec>
        
        <!-- We check the return for the commit below, since this is the development branch -->
        <echo msg="Committing changes to the current GIT branch '${state.vcs.branches.current.name}'." />
        <exec executable="${state.vcs.cmd}" dir="." checkreturn="false" passthru="true">
            <arg line="${state.vcs.cmd.commit} &quot;${state.vcs.commit.message}.&quot;" />
        </exec>

        <echo msg="Updating the version tag for the current GIT branch '${state.vcs.branches.current.name}'." />
        <exec executable="${state.pkg.cmd}" dir="." checkreturn="true" passthru="true">
            <arg line="${state.pkg.cmd.version.set} ${state.vcs.branches.current.name}" />
        </exec>  

        <echo msg="Pushing to remote upstream." />
        <exec executable="${state.vcs.cmd}" dir="." checkreturn="true" passthru="true">
            <arg line="${state.vcs.cmd.push} ${state.vcs.branches.current.name}" />
        </exec>
        
        <echo msg="Creating archive: " />
        <phingcall target="archive" />        
        
    </target>    
    
    
    
    
    
</project>